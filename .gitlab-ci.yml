stages: 
  - build_foundation
  - build
  - test
  - deploy
  - cleanup

ci_setup:
  stage: build_foundation
  script:
    - docker info
    - docker-compose version
    - git --version
    - sh ci_scripts/if_readme_only.sh 
    - echo $DOCKER_PASSWORD | docker login --username $DOCKER_USERNAME --password-stdin

pingfoundation:
  stage: build_foundation
  script:
    - docker image build -t pingidentity/pingcommon ./pingcommon
    - docker image build -t pingidentity/pingdatacommon ./pingdatacommon
    - docker image build -t pingidentity/pingbase ./pingbase

pingdownloader:
  stage: build_foundation
  script:
    - docker image build -t pingidentity/pingdownloader ./pingdownloader
    - docker-compose -f pingdownloader/build.test.yml up --exit-code-from sut
    - docker push pingidentity/pingdownloader
  only:
    changes:
      - pingdownloader/*
   
build_ldap-sdk-tools:
  stage: build
  script:
    - sh ci_scripts/build_and_tag.sh ldap-sdk-tools
  only:
    changes:
      - pingdownloader/*
      - ldap-sdk-tools/*

test_ldap-sdk-tools:
  stage: test
  script:
    - sh ci_scripts/run_tests.sh ldap-sdk-tools
  only:
    changes:
      - pingdownloader/*
      - ldap-sdk-tools/*

deploy_ldap-sdk-tools:
  stage: deploy
  script:
    - sh ci_scripts/deploy_to_docker_hub.sh ldap-sdk-tools
  only:
    changes:
      - ldap-sdk-tools/*

build_pingaccess:
  stage: build
  script:
    - sh ci_scripts/build_and_tag.sh pingaccess
  only:
    changes:
      - pingaccess/*
      - pingcommon/*
      - pingbase/*
      - pingdownloader/*

test_pingaccess:
  stage: test
  script:
    - sh ci_scripts/run_tests.sh pingaccess
  only:
    changes:
      - pingaccess/*
      - pingcommon/*
      - pingbase/*
      - pingdownloader/*
      
deploy_pingaccess:
  stage: deploy
  script:
    - sh ci_scripts/deploy_to_docker_hub.sh pingaccess
  only:
    changes:
      - pingaccess/*
      - pingcommon/*
      - pingbase/*

build_pingdirectory:
  stage: build
  script:
    - sh ci_scripts/build_and_tag.sh pingdirectory
  only:
    changes:
      - pingdirectory/*
      - pingcommon/*
      - pingdatacommon/*
      - pingbase/*
      - pingdownloader/*

test_pingdirectory:
  stage: test
  script:
    - sh ci_scripts/run_tests.sh pingdirectory
  only:
    changes:
      - pingdirectory/*
      - pingcommon/*
      - pingdatacommon/*
      - pingbase/*
      - pingdownloader/*

deploy_pingdirectory:
  stage: deploy
  script:
    - sh ci_scripts/deploy_to_docker_hub.sh pingdirectory
  only:
    changes:
      - pingdirectory/*
      - pingcommon/*
      - pingdatacommon/*
      - pingbase/*

build_pingdataconsole:
  stage: build
  script:
    - sh ci_scripts/build_and_tag.sh pingdataconsole
  only:
    changes:
      - pingdataconsole/*
      - pingdownloader/*

deploy_pingdataconsole:
  stage: deploy
  script:
    - sh ci_scripts/deploy_to_docker_hub.sh pingdataconsole
  only:
    changes:
      - pingdataconsole/*
      
build_pingdatasync:
  stage: build
  script:
    - sh ci_scripts/build_and_tag.sh pingdatasyne
  only:
    changes:
      - pingdatasync/*
      - pingcommon/*
      - pingdatacommon/*
      - pingbase/*
      - pingdownloader/*

test_pingdatasync:
  stage: test
  script:
    - sh ci_scripts/run_tests.sh pingdatasyne
  only:
    changes:
      - pingdatasync/*
      - pingcommon/*
      - pingdatacommon/*
      - pingbase/*
      - pingdownloader/*

deploy_pingdatasync:
  stage: deploy
  script:
    - sh ci_scripts/deploy_to_docker_hub.sh pingdatasyne
  only:
    changes:
      - pingdatasync/*
      - pingcommon/*
      - pingdatacommon/*
      - pingbase/*

build_pingfederate:
  stage: build
  script:
    - sh ci_scripts/build_and_tag.sh pingfederate
  only:
    changes:
      - pingfederate/*
      - pingcommon/*
      - pingbase/*
      - pingdownloader/*

test_pingfederate:
  stage: test
  script:
    - sh ci_scripts/run_tests.sh pingfederate
  only:
    changes:
      - pingfederate/*
      - pingcommon/*
      - pingbase/*
      - pingdownloader/*

deploy_pingfederate:
  stage: deploy
  script:
    - sh ci_scripts/deploy_to_docker_hub.sh pingfederate
  only:
    changes:
      - pingfederate/*
      - pingcommon/*
      - pingbase/*

# pingdirectoryproxy:
#   stage: build
#   script:
#     - docker image build -t pingidentity/pingdirectoryproxy ./pingdirectoryproxy
#     - docker push pingidentity/pingdirectoryproxy
#   only:
#     changes:
#       - pingdirectoryproxy/*
#       - pingcommon/*
#       - pingdatacommon/*
#       - pingbase/*
#       - pingdownloader/*
# pingdelegator:
#   stage: build
#   script:
#     - docker load -i images/pingcommon.tar
#     - docker load -i images/pingdatacommon.tar
#     - docker load -i images/pingbase.tar
#     - docker image build -t pingidentity/pingdelegator ./pingdelegator
#     - docker push pingidentity/pingdelegator
#   only:
#     changes:
#       - pingdelegator/*
#       - pingcommon/*
#       - pingbase/*
#       - pingdownloader/*

# push_to_github:
#   stage: deploy
#   script:
#     - git --version
#     - sh ci_scripts/push_to_github.sh
#   only:
#     - master

clean_containers:
  stage: cleanup
  script:
    - sh ci_scripts/docker-cleanup.sh
  when: always